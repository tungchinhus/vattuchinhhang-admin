<div class="product-form-container">
  <h2>Thêm Sản Phẩm Mới</h2>

  <mat-progress-bar *ngIf="isUploading" mode="indeterminate"></mat-progress-bar>

  <form [formGroup]="form" (ngSubmit)="save()">
    <mat-tab-group>
      <!-- Tab 1: Thông tin cơ bản -->
      <mat-tab label="Thông tin cơ bản">
        <div class="tab-content">
          <div class="form-grid">
            <mat-form-field appearance="outline">
              <mat-label>Mã sản phẩm (Product ID) *</mat-label>
              <input matInput formControlName="product_id" placeholder="VD: KADX69" />
              <mat-hint>Mã định danh duy nhất cho sản phẩm</mat-hint>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Tên sản phẩm *</mat-label>
              <input matInput formControlName="name" placeholder="Máy Lọc Nước..." />
              <button matSuffix mat-icon-button type="button" (click)="generateSlug()" matTooltip="Tạo slug tự động">
                <mat-icon>auto_fix_high</mat-icon>
              </button>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Slug *</mat-label>
              <input matInput formControlName="slug" placeholder="loc-nuoc-nong-lanh" />
              <mat-hint>URL thân thiện (tự động generate từ tên)</mat-hint>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Giá cơ bản (VND) *</mat-label>
              <input matInput type="number" formControlName="base_price" />
              <mat-hint>Giá gốc của sản phẩm</mat-hint>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Trạng thái tồn kho *</mat-label>
              <mat-select formControlName="stock_status">
                <mat-option value="in_stock">Còn hàng</mat-option>
                <mat-option value="out_of_stock">Hết hàng</mat-option>
                <mat-option value="on_order">Đang đặt hàng</mat-option>
              </mat-select>
            </mat-form-field>

            <mat-checkbox formControlName="is_published">Công khai sản phẩm</mat-checkbox>
          </div>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Mô tả ngắn</mat-label>
            <textarea matInput rows="2" formControlName="short_description"></textarea>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Mô tả chi tiết</mat-label>
            <textarea matInput rows="5" formControlName="description"></textarea>
          </mat-form-field>
        </div>
      </mat-tab>

      <!-- Tab 2: Danh mục -->
      <mat-tab label="Danh mục">
        <div class="tab-content">
          <h3>Chọn danh mục cho sản phẩm</h3>
          <div formGroupName="categories" class="category-grid">
            <mat-checkbox *ngFor="let cat of categories" [formControlName]="cat.id">
              {{ cat.name }}
            </mat-checkbox>
          </div>
        </div>
      </mat-tab>

      <!-- Tab 3: Biến thể -->
      <mat-tab label="Biến thể">
        <div class="tab-content">
          <div formArrayName="variants">
            <div *ngFor="let variantGroup of variantsArray.controls; let i = index" [formGroupName]="i" class="variant-item">
              <h4>Biến thể {{ i + 1 }}</h4>
              <div class="form-grid">
                <mat-form-field appearance="outline">
                  <mat-label>SKU *</mat-label>
                  <input matInput formControlName="sku" placeholder="VD: KADX69-S" />
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Kích thước/Mẫu *</mat-label>
                  <input matInput formControlName="size" placeholder="VD: Tủ Đứng" />
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Màu sắc *</mat-label>
                  <input matInput formControlName="color" placeholder="VD: Màu Xám Bạc" />
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Điều chỉnh giá (VND)</mat-label>
                  <input matInput type="number" formControlName="price_adjustment" />
                  <mat-hint>Cộng hoặc trừ từ giá cơ bản</mat-hint>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Số lượng tồn kho *</mat-label>
                  <input matInput type="number" formControlName="stock_quantity" />
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Giá cuối cùng (VND) *</mat-label>
                  <input matInput type="number" formControlName="final_price" [readonly]="true" />
                  <mat-hint>Tự động tính từ giá cơ bản + điều chỉnh</mat-hint>
                </mat-form-field>
              </div>
              <button mat-button color="warn" type="button" (click)="removeVariant(i)">
                <mat-icon>delete</mat-icon>
                Xóa biến thể
              </button>
            </div>

            <button mat-raised-button color="primary" type="button" (click)="addVariant()">
              <mat-icon>add</mat-icon>
              Thêm biến thể
            </button>
          </div>
        </div>
      </mat-tab>

      <!-- Tab 4: Hình ảnh -->
      <mat-tab label="Hình ảnh">
        <div class="tab-content">
          <h3>Upload hình ảnh sản phẩm</h3>
          
          <div class="upload-section">
            <input type="file" #fileInput multiple accept="image/*" (change)="onImageSelected($event)" style="display: none" />
            <button mat-raised-button color="primary" type="button" (click)="fileInput.click()">
              <mat-icon>cloud_upload</mat-icon>
              Chọn hình ảnh
            </button>
            <p class="hint">Hình đầu tiên sẽ là ảnh đại diện chính</p>
          </div>

          <div class="image-gallery" *ngIf="uploadedImages.length > 0">
            <div *ngFor="let img of uploadedImages; let i = index" class="image-item">
              <img [src]="img.preview" alt="Preview" />
              <div class="image-overlay">
                <div class="image-actions">
                  <button mat-icon-button *ngIf="i !== 0" (click)="setMainImage(i)" matTooltip="Đặt làm ảnh chính">
                    <mat-icon>star</mat-icon>
                  </button>
                  <button mat-icon-button color="warn" (click)="removeImage(i)">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
                <span class="image-label" *ngIf="i === 0">Ảnh chính</span>
              </div>
            </div>
          </div>

          <div *ngIf="uploadedImages.length === 0" class="no-images">
            <mat-icon>image</mat-icon>
            <p>Chưa có hình ảnh nào được tải lên</p>
          </div>
        </div>
      </mat-tab>
    </mat-tab-group>

    <div class="form-actions">
      <button mat-raised-button color="warn" type="button" (click)="form.reset()">
        <mat-icon>refresh</mat-icon>
        Xóa tất cả
      </button>
      <button mat-raised-button color="primary" type="submit" [disabled]="isUploading || form.invalid || variantsArray.length === 0">
        <mat-icon>save</mat-icon>
        Lưu sản phẩm
      </button>
    </div>
  </form>
</div>
