rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isAuthenticated() {
      return request.auth != null;
    }

    // ========== Catalog: Categories ==========
    match /categories/{categoryId} {
      allow read: if true;
      // Allow authenticated users to manage categories (can tighten to admin claims later)
      allow create, update, delete: if isAuthenticated();
    }

    // ========== Users subcollections ==========
    // Suppliers manage their own products
    match /users/{userId} {
      // Public user doc rules are handled elsewhere; here we protect subcollections
      match /products/{productId} {
        allow read: if true;
        allow create, update, delete: if isAuthenticated() && request.auth.uid == userId;

        // Product reviews: customers create their own reviews
        match /reviews/{reviewId} {
          allow read: if true;
          allow create: if isAuthenticated() && request.auth.uid == request.resource.data.customerId;
          allow update, delete: if isAuthenticated() && request.auth.uid == request.resource.data.customerId;
        }
      }

      // Customer orders: only owner can read/write
      match /orders/{orderId} {
        allow read, create, update, delete: if isAuthenticated() && request.auth.uid == userId;
      }
    }
    
    // Rules cho collection xeDuaDon
    match /xeDuaDon/{document} {
      allow read, write: if true; // Tạm thời cho phép tất cả để test
    }
    
    // Rules cho collection lichTrinhXe
    match /lichTrinhXe/{document} {
      allow read, write: if true; // Tạm thời cho phép tất cả để test
    }
    
    // Rules cho collection chiTietTuyenDuong
    match /chiTietTuyenDuong/{document} {
      allow read, write: if true; // Tạm thời cho phép tất cả để test
    }
    
    // Rules cho collection dangKyPhanXe
    match /dangKyPhanXe/{document} {
      allow read, write: if true; // Tạm thời cho phép tất cả để test
    }
    
    // Rules cho collection routeDetails (backup)
    match /routeDetails/{document} {
      allow read, write: if true; // Tạm thời cho phép tất cả để test
    }
    
    // Rules cho collection registrations
    match /registrations/{document} {
      allow read, write: if true; // Tạm thời cho phép tất cả để test
    }
    
    // Rules cho collection nhanVien
    match /nhanVien/{document} {
      allow read, write: if true; // Tạm thời cho phép tất cả để test
    }
    
    // Rules cho collection nhaXe
    match /nhaXe/{document} {
      allow read, write: if true; // Tạm thời cho phép tất cả để test
    }
    
    // Rules cho collection users (quản lý người dùng)
    match /users/{document} {
      allow read, write: if true; // Tạm thời cho phép tất cả để test (giữ nguyên theo hệ thống cũ)
    }
    
    // Rules cho collection roles (quản lý vai trò)
    match /roles/{document} {
      allow read, write: if true; // Tạm thời cho phép tất cả để test
    }
    
    // Rules cho collection permissions (quản lý quyền)
    match /permissions/{document} {
      allow read, write: if true; // Tạm thời cho phép tất cả để test
    }
    
    // Rules cho collection userRoles (liên kết người dùng-vai trò)
    match /userRoles/{document} {
      allow read, write: if true; // Tạm thời cho phép tất cả để test
    }
    
    // Rules cho collection userPermissions (liên kết người dùng-quyền)
    match /userPermissions/{document} {
      allow read, write: if true; // Tạm thời cho phép tất cả để test
    }
  }
}
